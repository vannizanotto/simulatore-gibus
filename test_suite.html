<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Suite - SVG Import & FEM Integration</title>
    <script src="fem_engine_v4.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; padding: 20px; background: #f5f5f5; }
        .test-container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { color: #2563eb; border-bottom: 3px solid #2563eb; padding-bottom: 10px; }
        h2 { color: #475569; margin-top: 30px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }
        .test-group { margin: 20px 0; padding: 15px; background: #f8fafc; border-left: 4px solid #3b82f6; border-radius: 4px; }
        .test-case { margin: 10px 0; padding: 10px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; }
        .test-result { padding: 8px; margin-top: 8px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .test-result.pass { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }
        .test-result.fail { background: #fee2e2; border: 1px solid #ef4444; color: #991b1b; }
        .test-result.warn { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; }
        .test-stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat { padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #cbd5e1; flex: 1; }
        .stat.passed { border-color: #10b981; }
        .stat.failed { border-color: #ef4444; }
        .stat.total { border-color: #3b82f6; }
        .stat-value { font-size: 32px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { color: #64748b; font-size: 14px; }
        pre { background: #1e293b; color: #4ade80; padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 11px; }
        .code-example { background: #f1f5f9; padding: 12px; border-radius: 4px; border: 1px solid #cbd5e1; margin: 10px 0; }
        button { padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px; }
        button:hover { background: #2563eb; }
        button:disabled { background: #94a3b8; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Suite - SVG Import & FEM Integration v4.1</h1>
        <p><strong>Versione:</strong> 1.0 | <strong>FEM Engine:</strong> v4.1 | <strong>Data:</strong> <span id="testDate"></span></p>
        
        <div class="test-stats">
            <div class="stat total">
                <div class="stat-value" id="totalTests">0</div>
                <div class="stat-label">Test Totali</div>
            </div>
            <div class="stat passed">
                <div class="stat-value" id="passedTests">0</div>
                <div class="stat-label">Superati</div>
            </div>
            <div class="stat failed">
                <div class="stat-value" id="failedTests">0</div>
                <div class="stat-label">Falliti</div>
            </div>
        </div>
        
        <div>
            <button onclick="runAllTests()">‚ñ∂Ô∏è Esegui Tutti i Test</button>
            <button onclick="runValidationTests()">üîç Solo Test Validazione</button>
            <button onclick="runImportTests()">üì• Solo Test Import</button>
            <button onclick="runIntegrationTests()">üîó Solo Test Integrazione</button>
            <button onclick="clearResults()">üóëÔ∏è Pulisci Risultati</button>
        </div>
        
        <div id="testResults"></div>
    </div>
    
    <script>
        // Test Statistics
        let stats = { total: 0, passed: 0, failed: 0 };
        
        // Initialize
        document.getElementById('testDate').textContent = new Date().toLocaleString('it-IT');
        
        // Test Framework
        class TestRunner {
            constructor() {
                this.results = [];
            }
            
            assert(condition, message) {
                if (!condition) {
                    throw new Error(message || 'Assertion failed');
                }
            }
            
            assertEquals(actual, expected, message) {
                if (actual !== expected) {
                    throw new Error(message || `Expected ${expected}, got ${actual}`);
                }
            }
            
            assertAlmostEquals(actual, expected, tolerance, message) {
                if (Math.abs(actual - expected) > tolerance) {
                    throw new Error(message || `Expected ~${expected}, got ${actual}`);
                }
            }
            
            assertExists(obj, message) {
                if (obj === null || obj === undefined) {
                    throw new Error(message || 'Object should exist');
                }
            }
            
            run(testName, testFn) {
                try {
                    testFn.call(this);
                    this.results.push({ name: testName, status: 'pass', message: '‚úì Test superato' });
                    stats.passed++;
                } catch (error) {
                    this.results.push({ name: testName, status: 'fail', message: `‚úó ${error.message}` });
                    stats.failed++;
                } finally {
                    stats.total++;
                }
            }
            
            getResults() {
                return this.results;
            }
            
            clear() {
                this.results = [];
                stats = { total: 0, passed: 0, failed: 0 };
            }
        }
        
        const runner = new TestRunner();
        
        // =============================================================================
        // TEST GROUP 1: SVGProfileImporter - Validazione Dati
        // =============================================================================
        function runValidationTests() {
            addTestGroup('Gruppo 1: Validazione Dati Import SVG');
            
            runner.run('Test 1.1: Validazione dati completi', function() {
                const importer = new SVGProfileImporter();
                const testData = {
                    width: 0.033,
                    height: 0.062,
                    t_v: 0.003,
                    t_h: 0.003,
                    area: 0.000234,
                    materialKey: '6061-T6',
                    femEngineVersion: '4.1'
                };
                
                const validation = importer.validateImportData(testData);
                this.assert(validation.isValid, 'Dati validi devono passare la validazione');
                this.assertEquals(validation.errors.length, 0, 'Nessun errore atteso');
            });
            
            runner.run('Test 1.2: Rilevamento propriet√† mancanti', function() {
                const importer = new SVGProfileImporter();
                const testData = {
                    width: 0.033
                    // height, area, materialKey mancanti
                };
                
                const validation = importer.validateImportData(testData);
                this.assert(!validation.isValid, 'Dati incompleti devono fallire');
                this.assert(validation.errors.length > 0, 'Deve rilevare errori');
            });
            
            runner.run('Test 1.3: Warning per dimensioni inusuali', function() {
                const importer = new SVGProfileImporter();
                const testData = {
                    width: 2.0, // Troppo grande
                    height: 0.062,
                    area: 0.01,
                    materialKey: '6061-T6'
                };
                
                const validation = importer.validateImportData(testData);
                this.assert(validation.warnings.length > 0, 'Deve generare warning per larghezza eccessiva');
            });
            
            runner.run('Test 1.4: Mapping materiali', function() {
                const importer = new SVGProfileImporter();
                
                // Test mapping diretto
                this.assertEquals(importer.materialMapping['6061-T6'], '6061-T6');
                this.assertEquals(importer.materialMapping['7075-T6'], '7075-T6');
                
                // Test fallback
                this.assertEquals(importer.materialMapping['6005A-T6'], '6082-T6');
            });
            
            updateStats();
            displayResults();
        }
        
        // =============================================================================
        // TEST GROUP 2: Creazione Sezioni da Import
        // =============================================================================
        function runImportTests() {
            addTestGroup('Gruppo 2: Creazione Sezioni FEM da Dati SVG');
            
            runner.run('Test 2.1: Creazione BeamSection standard', function() {
                const importer = new SVGProfileImporter();
                const testData = {
                    width: 0.033,
                    height: 0.062,
                    t_v: 0.003,
                    t_h: 0.003,
                    area: 0.000234,
                    inertia_Ixx: 2.45e-8,
                    inertia_Iyy: 8.12e-9,
                    materialKey: '6061-T6'
                };
                
                const section = importer.createSectionFromImport(testData);
                
                this.assertExists(section, 'Sezione deve essere creata');
                this.assertEquals(section.W, 0.033, 'Larghezza corretta');
                this.assertEquals(section.H, 0.062, 'Altezza corretta');
                this.assert(section.A > 0, 'Area deve essere positiva');
            });
            
            runner.run('Test 2.2: Creazione BeamSectionWithHoles', function() {
                const importer = new SVGProfileImporter();
                const testData = {
                    width: 0.033,
                    height: 0.062,
                    t_v: 0.003,
                    t_h: 0.003,
                    area: 0.000234,
                    materialKey: '6082-T6'
                };
                
                const section = importer.createSectionFromImport(testData, {
                    addHoles: true,
                    numHoles: 3,
                    holeDiameter_mm: 4.2,
                    holeSpacing_mm: 50
                });
                
                this.assertExists(section, 'Sezione con fori deve essere creata');
                this.assert(section instanceof BeamSectionWithHoles, 'Deve essere BeamSectionWithHoles');
                this.assertEquals(section.numHoles, 3, 'Numero fori corretto');
            });
            
            runner.run('Test 2.3: Import batch multiplo', function() {
                const importer = new SVGProfileImporter();
                const exportData = {
                    version: '6.5',
                    femEngineVersion: '4.1',
                    sections: [
                        {
                            width: 0.033,
                            height: 0.062,
                            area: 0.000234,
                            materialKey: '6061-T6',
                            slotId: 1
                        },
                        {
                            width: 0.040,
                            height: 0.070,
                            area: 0.000312,
                            materialKey: '6082-T6',
                            slotId: 2
                        }
                    ]
                };
                
                const sections = importer.importBatch(exportData);
                
                this.assertEquals(sections.length, 2, 'Deve importare 2 sezioni');
                this.assertEquals(sections[0].slotId, 1, 'SlotId corretto per sezione 1');
                this.assertEquals(sections[1].slotId, 2, 'SlotId corretto per sezione 2');
            });
            
            runner.run('Test 2.4: Helper fromClipboard', function() {
                const jsonData = JSON.stringify({
                    sections: [{
                        width: 0.033,
                        height: 0.062,
                        area: 0.000234,
                        materialKey: '6061-T6'
                    }]
                });
                
                const sections = SVGProfileImporter.fromClipboard(jsonData);
                
                this.assert(sections.length > 0, 'Deve importare da JSON clipboard');
                this.assertExists(sections[0].section, 'Sezione deve esistere');
            });
            
            updateStats();
            displayResults();
        }
        
        // =============================================================================
        // TEST GROUP 3: Integrazione FEM Completa
        // =============================================================================
        function runIntegrationTests() {
            addTestGroup('Gruppo 3: Integrazione FEM Completa');
            
            runner.run('Test 3.1: Verifica propriet√† MATERIALS_V4', function() {
                const material = MATERIALS_V4['6061-T6'];
                
                this.assertExists(material, 'Materiale 6061-T6 deve esistere');
                this.assert(material.E > 0, 'Modulo elastico deve essere positivo');
                this.assert(material.yield > 0, 'Snervamento deve essere positivo');
                this.assert(material.tensile > material.yield, 'UTS > Yield');
            });
            
            runner.run('Test 3.2: Calcolo propriet√† sezione importata', function() {
                const importer = new SVGProfileImporter();
                const testData = {
                    width: 0.060,  // 60mm
                    height: 0.040,  // 40mm
                    t_v: 0.003,
                    t_h: 0.003,
                    area: 0.0006,
                    materialKey: '6061-T6'
                };
                
                const section = importer.createSectionFromImport(testData);
                section.calculate();
                
                this.assert(section.A > 0, 'Area calcolata deve essere positiva');
                this.assert(section.I > 0, 'Inerzia calcolata deve essere positiva');
                this.assert(section.S > 0, 'Modulo resistenza deve essere positivo');
            });
            
            runner.run('Test 3.3: Compatibilit√† con HoleStressAnalysis', function() {
                const holeAnalysis = new HoleStressAnalysis({
                    d: 4.2,
                    p: 50,
                    t: 3,
                    W: 33,
                    n: 3,
                    material: '6061-T6'
                });
                
                const Kt = holeAnalysis.getEffectiveKt();
                
                this.assert(Kt >= 1.0, 'Kt deve essere >= 1.0');
                this.assert(Kt <= 4.0, 'Kt deve essere ragionevole (<= 4.0)');
            });
            
            runner.run('Test 3.4: LocalMeshRefinement esistenza', function() {
                this.assertExists(window.LocalMeshRefinement, 'LocalMeshRefinement deve essere disponibile');
                
                const mesh = new LocalMeshRefinement(
                    { centerX: 0, centerY: 0, radius: 2, domainSize: 16 },
                    MATERIALS_V4['6061-T6']
                );
                
                this.assertExists(mesh, 'Mesh deve essere creata');
            });
            
            runner.run('Test 3.5: DynamicAnalysis esistenza', function() {
                this.assertExists(window.DynamicAnalysis, 'DynamicAnalysis deve essere disponibile');
                // Test costruzione base (senza eseguire analisi pesante)
                this.assert(typeof DynamicAnalysis === 'function', 'Deve essere una classe');
            });
            
            updateStats();
            displayResults();
        }
        
        // =============================================================================
        // TEST GROUP 4: Ottimizzazione Contorni
        // =============================================================================
        function runOptimizationTests() {
            addTestGroup('Gruppo 4: Ottimizzazione Contorni SVG');
            
            runner.run('Test 4.1: Douglas-Peucker semplificazione', function() {
                const importer = new SVGProfileImporter();
                
                // Crea contorno con molti punti
                const contour = [];
                for (let i = 0; i <= 100; i++) {
                    const angle = (i / 100) * 2 * Math.PI;
                    contour.push({
                        x: Math.cos(angle) * 10,
                        y: Math.sin(angle) * 10
                    });
                }
                
                const simplified = importer.optimizeContoursForFEM([contour], { tolerance: 0.5, maxPoints: 50 });
                
                this.assert(simplified[0].length < contour.length, 'Deve semplificare il contorno');
                this.assert(simplified[0].length <= 50, 'Deve rispettare maxPoints');
            });
            
            runner.run('Test 4.2: Contorni gi√† semplici non modificati', function() {
                const importer = new SVGProfileImporter();
                const simpleContour = [
                    {x: 0, y: 0},
                    {x: 10, y: 0},
                    {x: 10, y: 10},
                    {x: 0, y: 10},
                    {x: 0, y: 0}
                ];
                
                const result = importer.optimizeContoursForFEM([simpleContour], { maxPoints: 200 });
                
                this.assertEquals(result[0].length, simpleContour.length, 'Contorno semplice non deve essere modificato');
            });
            
            updateStats();
            displayResults();
        }
        
        // =============================================================================
        // UI Functions
        // =============================================================================
        function addTestGroup(title) {
            const container = document.getElementById('testResults');
            const group = document.createElement('div');
            group.className = 'test-group';
            group.innerHTML = `<h2>${title}</h2>`;
            group.id = 'current-group';
            container.appendChild(group);
        }
        
        function displayResults() {
            const currentGroup = document.getElementById('current-group');
            if (!currentGroup) return;
            
            const results = runner.getResults();
            results.forEach(result => {
                const testCase = document.createElement('div');
                testCase.className = 'test-case';
                
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${result.status}`;
                resultDiv.textContent = result.message;
                
                testCase.innerHTML = `<strong>${result.name}</strong>`;
                testCase.appendChild(resultDiv);
                
                currentGroup.appendChild(testCase);
            });
            
            currentGroup.removeAttribute('id');
        }
        
        function updateStats() {
            document.getElementById('totalTests').textContent = stats.total;
            document.getElementById('passedTests').textContent = stats.passed;
            document.getElementById('failedTests').textContent = stats.failed;
        }
        
        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            runner.clear();
            updateStats();
        }
        
        function runAllTests() {
            clearResults();
            runValidationTests();
            runImportTests();
            runIntegrationTests();
            runOptimizationTests();
            
            // Summary
            addTestGroup('üìä Riepilogo Finale');
            const summary = document.getElementById('current-group');
            summary.innerHTML += `
                <div style="padding: 20px; text-align: center; font-size: 18px; font-weight: bold;">
                    ${stats.passed === stats.total ? 'üéâ TUTTI I TEST SUPERATI!' : '‚ö†Ô∏è ALCUNI TEST FALLITI'}
                </div>
                <pre>${stats.passed}/${stats.total} test superati (${((stats.passed/stats.total)*100).toFixed(1)}%)</pre>
            `;
            summary.removeAttribute('id');
        }
        
        // Example Code Display
        function showExampleUsage() {
            const example = `
// Esempio 1: Import da clipboard
const jsonData = '...'; // JSON da import_000.html
const sections = SVGProfileImporter.fromClipboard(jsonData);
const mySection = sections[0].section;

// Esempio 2: Import manuale con opzioni
const importer = new SVGProfileImporter();
const sectionData = { width: 0.033, height: 0.062, ... };
const sectionWithHoles = importer.createSectionFromImport(sectionData, {
    addHoles: true,
    numHoles: 3,
    holeDiameter_mm: 4.2
});

// Esempio 3: Validazione
const validation = importer.validateImportData(sectionData);
if (!validation.isValid) {
    console.error('Errori:', validation.errors);
}
            `;
            
            addTestGroup('üíª Esempi di Utilizzo');
            const group = document.getElementById('current-group');
            group.innerHTML += `<pre>${example}</pre>`;
            group.removeAttribute('id');
        }
    </script>
</body>
</html>
